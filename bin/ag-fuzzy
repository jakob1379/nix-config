#!/usr/bin/env bash

set -euo pipefail

eval "$(batman --export-env)"

ag_fuzzy_search() {
    if [ $# -gt 0 ]; then
        ag --nocolor --column "$@" 2>/dev/null
    else
        ag --nocolor --column . 2>/dev/null
    fi
}

ag_fuzzy_preview() {
    local entry="$1"
    local query="${2:-}"

    local file line
    file=$(echo "$entry" | cut -d: -f1)
    line=$(echo "$entry" | cut -d: -f2)


    [ -z "$file" ] || [ ! -f "$file" ] || [ -z "$line" ] && exit 1
    bat --force-colorization --style=numbers,header-filename --highlight-line $line "$file"
}
export -f ag_fuzzy_preview

ag_fuzzy_file() {
    echo "$1" | cut -d: -f1
}
export -f ag_fuzzy_file

ag_fuzzy_line() {
    echo "$1" | cut -d: -f2
}
export -f ag_fuzzy_line

get_editor_cmd() {
    local file="$1" line="$2"
    local editor="${EDITOR:-${VISUAL:-vim}}"

    case "$editor" in
        *nvim*|*vim*) echo "$editor +$line $file" ;;
        *emacs*) echo "emacsclient --no-wait +$line $file" ;;
        nano) echo "$editor +$line $file" ;;
        code) echo "$editor --goto $file:$line" ;;
        subl|*sublime*) echo "$editor $file:$line" ;;
        vi) echo "$editor +$line $file" ;;
        *) echo "$editor +$line $file" ;;
    esac
}

mapfile -t selections < <(
    ag_fuzzy_search "$@" | \
    fzf \
        --delimiter=: \
        --with-nth 1.. \
        --ansi \
        --prompt="ðŸ”Ž Ag> " \
        --scheme=history \
        --tac \
        --bind "alt-enter:execute-silent($(get_editor_cmd "$(ag_fuzzy_file {})" "$(ag_fuzzy_line {})"))" \
        --bind "ctrl-y:execute-silent(ag_fuzzy_file {} | wl-copy 2>/dev/null)" \
        --bind "tab:down" \
        --bind "ctrl-l:toggle-preview" \
        --preview-window="down:60%:wrap:~3,+{2}+3/2" \
        --preview 'ag_fuzzy_preview {} {q}' \
        --header $'ENTER print â€¢ Alt-Enter editor â€¢ Ctrl-Y copy â€¢ Ctrl-L preview' \
        --info=inline
)

status=$?
[ $status -eq 130 ] && exit 130
[ ${#selections[@]} -eq 0 ] && exit 0

for entry in "${selections[@]}"; do
    echo "$entry"
done
